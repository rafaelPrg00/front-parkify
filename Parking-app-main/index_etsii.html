<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reserva de parking</title>
  <link rel="icon" type="image/png" href="imagenes/coche.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Satisfy&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet"> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen bg-neutral-50 text-neutral-800">
  <div class="barra-sitio-simple">
        <a class="logo-link">
            <img src="imagenes/coche.png" alt="Logo Parkify" class="logo-pequeno">
            <span class="nombre-sitio">Parkify</span>
        </a>
        <a href="index.html" class="enlace-casa">
            <img src="imagenes/lococasa2.png" alt="Inicio" class="icono-casa-img">
        </a> 
        </a>
  </div>

  <!--CABEZERA-->
  <header class="bg-neutral-800 text-white">
    <div class="w-full px-3 py-2 flex items-center justify-between">

      <img src="assets/logoUS.png"
           class="w-6 sm:w-8 md:w-10 lg:w-12 h-auto"
           alt="Logo Universidad de Sevilla">

      <h1 class="font-bold text-lg md:text-2xl text-center font-mont">Reserva de parking Escuela Técnica Superior de Ingeniería Informática</h1>

      <div class="flex items-center space-x-7">
        <button onclick="salir()"><img src="assets/logo_salir.png" class="w-12" alt="salir"></button>
      </div>

    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-6" x-data="parkingApp()">

    <section class="grid gap-4 md:grid-cols-3">
      <div class="md:col-span-2 rounded-2xl border bg-white p-4">

        <!--Selección de fecha y hora-->
        <h2 class="text-lg font-semibold mb-4">Selecciona horario</h2>
        <div class="flex gap-3 items-center mb-4">
          <label class="text-sm text-neutral-600">Fecha</label>
          <input type="date" x-model="date"
                 class="rounded-xl border px-3 py-2 text-sm" />
          <div class="ml-auto inline-flex items-center gap-2 rounded-xl border px-3 py-2 bg-green-50 border-green-200">
            <span class="h-2 w-2 rounded-full bg-green-500"></span>
            <span class="text-sm font-medium" x-text="availabilityLabel()"></span>
          </div>
        </div>
        
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="block text-sm text-neutral-600 mb-1">Hora de entrada</label>
            <input type="time" min="07:00" max="23:00" x-model="start"
                   class="w-full rounded-xl border px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm text-neutral-600 mb-1">Hora de salida</label>
            <input type="time" min="07:00" max="23:00" x-model="end"
                   class="w-full rounded-xl border px-3 py-2" />
          </div>
        </div>

        <!-- PLANO -->
        <img src="assets/parking_etsii.png"
             alt="Plano de parkings"
             class="w-2/3 mx-auto rounded-xl mb-6 mt-4 shadow-md">

        <!-- BOTÓN CONSULTAR -->
        <div class="mt-4">
          <button @click="checkAvailability"
                  class="rounded-xl bg-neutral-900 text-white px-4 py-2 text-sm hover:bg-black">
            Consultar disponibilidad
          </button>
          <span class="ml-3 text-sm text-neutral-600" x-show="loading">cargando…</span>
        </div>

        <!-- BOTONES DE ZONA (RESERVA POR ZONA) -->
        <div class="mt-6" x-show="zones.length">
          <div class="text-sm font-medium mb-2">Disponibilidad por parking</div>

          <div class="space-y-2">
            <template x-for="z in zones" :key="z.id">
              <button type="button"
                      @click="selectedZone = z"
                      class="w-full flex items-center justify-between rounded-xl border px-3 py-2 text-sm bg-neutral-50 transition
                             hover:bg-neutral-100"
                      :class="selectedZone?.id === z.id
                               ? 'border-neutral-800 ring-1 ring-neutral-800'
                               : 'border-neutral-200'">
                <div class="flex items-center gap-2">
                  <span :class="dotClass(z.zone)" class="h-2 w-2 rounded-full"></span>
                  <span class="font-medium" x-text="z.name"></span>
                </div>
                <span x-text="`${z.free} plazas disponibles`"></span>
              </button>
            </template>
          </div>
        </div>

      </div>


      <!-- BLOQUE DERECHO (RESUMEN) -->
      <aside class="space-y-4">

        <!-- editar coche -->
        <div class="rounded-2xl border bg-white p-4">
          <div class="text-sm font-semibold mb-3">Tu vehículo</div>

          <div class="flex items-center gap-3 mb-3">
            <img src="assets/logo_coche.png" class="w-10" alt="">
            <div>
              <div class="font-semibold tracking-wide" x-text="vehicle.plate"></div>
              <div class="text-sm text-neutral-600" x-text="vehicle.model"></div>
            </div>
          </div>

          <button @click="openVehicleModal()"
                  class="rounded-xl bg-blue-600 text-white px-3 py-2 text-sm hover:bg-blue-700">
            Editar
          </button>
        </div>

        <!-- reserva -->
        <div class="rounded-2xl border bg-white p-4">
          <div class="text-sm font-semibold mb-2">Resumen de la reserva</div>

          <ul class="text-sm space-y-1">
            <li><span class="font-medium">Zona:</span> <span x-text="selectedZone?.name || '—'"></span></li>
            <li><span class="font-medium">Fecha:</span> <span x-text="prettyDate()"></span></li>
            <li><span class="font-medium">Hora:</span> <span x-text="`${start} - ${end}`"></span></li>
            <li><span class="font-medium">Coste:</span> <span x-text="`${costEuros()} €`"></span></li>
          </ul>

          <div class="mt-3 text-xs text-red-700 bg-red-50 rounded-xl p-2" x-show="invalidRange()">
            La hora de salida debe ser posterior a la de entrada.
          </div>

          <div class="mt-4 flex gap-2">
            <button @click="confirm"
                    :disabled="invalidRange() || !selectedZone"
                    class="flex-1 rounded-xl bg-green-500 text-white px-3 py-2 text-sm font-medium enabled:hover:bg-green-600 disabled:opacity-60">
              Confirmar
            </button>

            <button class="flex-1 rounded-xl bg-neutral-300 px-3 py-2 text-sm">Cancelar</button>
          </div>
        </div>

      </aside>

    </section>

    <div x-cloak
         x-show="showVehicleModal"
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div @click.away="closeVehicleModal()"
           class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-5">
        <h3 class="text-base font-semibold mb-4">Editar vehículo</h3>

        <div class="space-y-3">
          <div>
            <label class="block text-sm text-neutral-700 mb-1">Matrícula</label>
            <input type="text"
                   x-model="tempVehicle.plate"
                   class="w-full rounded-xl border px-3 py-2 text-sm"
                   placeholder="Ej: 1234-ABC">
          </div>

          <div>
            <label class="block text-sm text-neutral-700 mb-1">Modelo</label>
            <input type="text"
                   x-model="tempVehicle.model"
                   class="w-full rounded-xl border px-3 py-2 text-sm"
                   placeholder="Ej: Seat Ibiza">
          </div>
        </div>

        <div class="mt-5 flex justify-end gap-2">
          <button type="button"
                  @click="closeVehicleModal()"
                  class="rounded-xl px-3 py-2 text-sm border border-neutral-300">
            Cancelar
          </button>
          <button type="button"
                  @click="saveVehicleModal()"
                  class="rounded-xl px-3 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700">
            Guardar
          </button>
        </div>
      </div>
    </div>

  </main>


  <!-- LÓGICA ALPINE.JS -->
  <script>
    function salir(){
      window.localStorage.removeItem("UserId")
      window.location.href = "index.html"
    }
    function parkingApp() {
      return {
        date: new Date().toISOString().slice(0,10),
        start: '16:00',
        end: '17:00',
        loading: false,
        spaces: [],        // seguimos usándolo para calcular counts
        zones: [],
        selectedZone: null,

        vehicle: { plate: 'ABC-1234', model: 'Seat Ibiza' },

        dotClass(zone){
          return zone === 'verde'    ? 'bg-green-500'
               : zone === 'amarilla' ? 'bg-yellow-400'
               : zone === 'azul'     ? 'bg-blue-500'
               : 'bg-neutral-400';
        },

        prettyDate(){
          return new Date(this.date+'T00:00')
            .toLocaleDateString('es-ES', { day:'numeric', month:'long' });
        },
        
        openVehicleModal(){
          this.tempVehicle = { ...this.vehicle };
          this.showVehicleModal = true;
        },

        // Cerrar modal sin guardar
        closeVehicleModal(){
          this.showVehicleModal = false;
        },

        // Guardar cambios
        saveVehicleModal(){
          this.vehicle = { ...this.tempVehicle };
          this.showVehicleModal = false;
        },

        invalidRange(){ return this.start >= this.end; },

        minutes(){
          const [sh,sm] = this.start.split(':').map(Number);
          const [eh,em] = this.end.split(':').map(Number);
          return Math.max(0, (eh*60+em)-(sh*60+sm));
        },

        costEuros(){ return (this.minutes()/60*2.5).toFixed(2); },

        availabilityLabel(){
          const pct = Math.min(95, 10 + Math.floor((this.date+this.start+this.end).length*7) % 80);
          return pct + '% disponible';
        },

        // CONSULTAR DISPONIBILIDAD
        async checkAvailability(){
          this.loading = true;
          await new Promise(r=>setTimeout(r,400));

          // En producción esto vendría del backend
          const mock = [
            {label:'B1', zone:'verde'},
            {label:'B2', zone:'verde'},
            {label:'C1', zone:'amarilla'},
            {label:'D9', zone:'azul'},
            {label:'E3', zone:'verde'}
          ];

          const seed = (this.date+this.start+this.end)
                        .split('').reduce((a,c)=>a+c.charCodeAt(0),0);

          this.spaces = mock.slice(0, 2 + (seed % (mock.length-1)));

          // Calcular cuántas plazas por zona
          const counts = {};
          this.spaces.forEach(s => {
            counts[s.zone] = (counts[s.zone] || 0) + 1;
          });

          this.zones = [
            { id:'principal', name:'Parking Principal', zone:'verde',    free:counts['verde'] || 0 },
            { id:'sur',       name:'Parking Sur',       zone:'amarilla', free:counts['amarilla'] || 0 },
            { id:'norte',     name:'Parking Norte',     zone:'azul',     free:counts['azul'] || 0 }
          ];

          // Seleccionamos por defecto la primera zona con plazas
          this.selectedZone = this.zones.find(z => z.free > 0) || null;

          this.loading = false;
        },

        confirm(){
          if (this.invalidRange() || !this.selectedZone) return;

          alert(
            `Reserva (demo)\n` +
            `Zona: ${this.selectedZone.name}\n` +
            `Fecha: ${this.prettyDate()}\n` +
            `Hora: ${this.start}-${this.end}\n` +
            `Coste: ${this.costEuros()} €\n` +
            `Vehículo: ${this.vehicle.plate}`
          );
        }
      }
    }
  </script>

</body>
</html>
